<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bill Nova | Login</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    <style>
        body { margin:0; background:#0f172a; color:white; font-family:'Inter', sans-serif; display:flex; justify-content:center; align-items:center; height:100vh; }
        .box { width:360px; padding:40px; background:#1e293b; border-radius:16px; border:1px solid rgba(255,255,255,0.1); text-align:center; box-shadow:0 20px 25px -5px rgba(0,0,0,0.5); }
        input { width:100%; padding:12px; margin:10px 0; border-radius:8px; border:1px solid #334155; background:#0f172a; color:white; box-sizing:border-box; outline:none; }
        input:focus { border-color: #3b82f6; }
        button { width:100%; padding:12px; margin-top:10px; border-radius:8px; border:none; background:#3b82f6; color:white; font-weight:600; cursor:pointer; transition:0.3s; }
        button:hover { background:#2563eb; }
        button:disabled { background:#334155; color:#64748b; cursor:not-allowed; }
        .google-btn { background:white; color:#0f172a; margin-top:20px; display:flex; align-items:center; justify-content:center; gap:10px; }
        hr { border:0; border-top:1px solid #334155; margin:25px 0; }
    </style>
</head>
<body>

<div class="box">
    <h1 style="color:#3b82f6; margin-bottom:5px;">Bill Nova</h1>
    <p style="color:#94a3b8; margin-bottom:30px;">Professional Billing Suite</p>

    <input id="loginUsername" placeholder="Username (Unique)">
    <input id="loginKey" placeholder="Daily Login Key (min 6 chars)" type="password">
    <button onclick="userLogin()" id="loginBtn">Fast Login</button>

    <hr>

    <button class="google-btn" onclick="googleLogin()">
        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="18">
        Sign in with Google
    </button>
</div>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyBNQbvniq3dP6yfX-PGTu3dNuf-6jto3bU",
    authDomain: "bill-nova.firebaseapp.com",
    projectId: "bill-nova"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// Redirect Logic with Username Mapping
async function handleUserRedirect(user, isGoogle = false) {
    const userDoc = await db.collection("users").doc(user.uid).get();
    
    if (userDoc.exists) {
        location.href = "dashboard.html";
    } else {
        // Agar naya user hai (Google ya FastLogin), usey setup pe bhejo
        location.href = "setup.html";
    }
}

window.googleLogin = function() {
    const provider = new firebase.auth.GoogleAuthProvider();
    auth.signInWithPopup(provider)
        .then((result) => handleUserRedirect(result.user, true))
        .catch(err => alert("Google Error: " + err.message));
};

window.userLogin = async function() {
    const u = document.getElementById('loginUsername').value.trim().toLowerCase().replace(/\s+/g, '');
    const k = document.getElementById('loginKey').value.trim();
    const btn = document.getElementById('loginBtn');

    if(!u || k.length < 6) return alert("Bhai, valid Username aur 6-digit Key chahiye!");

    btn.disabled = true;
    btn.innerText = "Checking...";

    const fakeEmail = u + "@billnova.com";

    try {
        // Step 1: Pehle check karo ki ye username kisi ne le toh nahi rakha (Different Key ke sath)
        // Firebase auth login try karega
        const result = await auth.signInWithEmailAndPassword(fakeEmail, k);
        handleUserRedirect(result.user);
    } catch (err) {
        if (err.code === 'auth/user-not-found') {
            // Naya unique username account banana
            try {
                const newUser = await auth.createUserWithEmailAndPassword(fakeEmail, k);
                location.href = "setup.html";
            } catch (createErr) {
                alert("Error: " + createErr.message);
                resetBtn();
            }
        } else if (err.code === 'auth/wrong-password' || err.code === 'auth/invalid-credential') {
            alert("Bhai, ye Username booked hai! Sahi Key daliye ya naya username chuniye.");
            resetBtn();
        } else {
            alert("Login Failed: " + err.message);
            resetBtn();
        }
    }
};

function resetBtn() {
    const btn = document.getElementById('loginBtn');
    btn.disabled = false;
    btn.innerText = "Fast Login";
}
</script>
</body>
</html>
