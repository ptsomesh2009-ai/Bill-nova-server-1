<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bill Nova | Portal</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    <style>
        body { margin:0; background:#0f172a; color:white; font-family:'Inter', sans-serif; display:flex; justify-content:center; align-items:center; height:100vh; }
        .box { width:380px; padding:40px; background:#1e293b; border-radius:16px; border:1px solid rgba(255,255,255,0.1); text-align:center; box-shadow:0 20px 25px -5px rgba(0,0,0,0.5); }
        h1 { color:#3b82f6; margin-bottom:5px; font-size: 2rem; }
        p { color:#94a3b8; margin-bottom:30px; }
        button { width:100%; padding:14px; margin-top:15px; border-radius:10px; border:none; font-weight:600; cursor:pointer; transition:0.3s; display:flex; align-items:center; justify-content:center; gap:10px; font-size: 0.95rem; }
        .login-btn { background:#3b82f6; color:white; }
        .login-btn:hover { background:#2563eb; }
        .signup-btn { background:white; color:#0f172a; }
        .signup-btn:hover { background:#f1f5f9; }
        button:disabled { background:#334155 !important; color:#64748b !important; cursor:not-allowed; border: 1px solid #475569; }
        #errorNotice { color: #ef4444; font-size: 13px; margin-top: 15px; display: none; padding: 10px; background: rgba(239, 68, 68, 0.1); border-radius: 8px; }
        .limit-tag { font-size: 11px; margin-top: 10px; color: #64748b; }
    </style>
</head>
<body>

<div class="box">
    <h1>Bill Nova</h1>
    <p>Professional Billing Suite</p>

    <button class="login-btn" onclick="handleAuth('login')" id="loginBtn">
        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="18">
        Login with Google
    </button>

    <button class="signup-btn" onclick="handleAuth('signup')" id="signupBtn">
        <i class="fas fa-plus"></i> Create New Account
    </button>
    
    <div class="limit-tag" id="userCountStatus">Checking slot availability...</div>
    <div id="errorNotice"></div>
</div>

<script>
// Firebase Config
const firebaseConfig = {
    apiKey: "AIzaSyBNQbvniq3dP6yfX-PGTu3dNuf-6jto3bU",
    authDomain: "bill-nova.firebaseapp.com",
    projectId: "bill-nova"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// 10 User Limit System
let registrationOpen = true;

async function checkUserLimit() {
    try {
        const snapshot = await db.collection("users").get();
        const totalUsers = snapshot.size;
        document.getElementById('userCountStatus').innerText = `Slots: ${totalUsers}/10 users registered`;
        
        if (totalUsers >= 10) {
            registrationOpen = false;
            document.getElementById('signupBtn').disabled = true;
            document.getElementById('signupBtn').innerText = "Registration Full (10/10)";
        }
    } catch (err) {
        console.error("Limit Check Error:", err);
    }
}
checkUserLimit();

function showError(msg) {
    const n = document.getElementById('errorNotice');
    n.innerText = msg;
    n.style.display = 'block';
    setTimeout(() => { n.style.display = 'none'; }, 5000);
}

async function handleAuth(mode) {
    const provider = new firebase.auth.GoogleAuthProvider();
    try {
        const result = await auth.signInWithPopup(provider);
        const user = result.user;
        
        // Check if user exists in our Firestore
        const userDoc = await db.collection("users").doc(user.uid).get();

        if (mode === 'login') {
            if (userDoc.exists) {
                // User exists, allow access
                location.href = "dashboard.html";
            } else {
                // User doesn't exist in DB
                await auth.signOut();
                showError("No account found with this Google ID. Please 'Create New Account' first.");
            }
        } 
        else if (mode === 'signup') {
            if (userDoc.exists) {
                // Already has an account, just go to dashboard
                location.href = "dashboard.html";
            } else {
                if (!registrationOpen) {
                    await auth.signOut();
                    showError("Sorry, we have reached the 10-user limit.");
                    return;
                }
                // New user and slots available
                location.href = "setup.html";
            }
        }
    } catch (err) {
        showError("Auth Failed: " + err.message);
    }
}
</script>

</body>
</html>
