<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Create Invoice | Bill Nova</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>

    <style>
        :root { --primary: #3b82f6; --bg-dark: #0f172a; --card-bg: #1e293b; --text-main: #f8fafc; --text-dim: #94a3b8; --border: rgba(255, 255, 255, 0.1); }
        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg-dark); color: var(--text-main); display: flex; min-height: 100vh; }
        
        /* Sidebar */
        .sidebar { width: 260px; background: rgba(15, 23, 42, 0.9); border-right: 1px solid var(--border); padding: 30px 20px; }
        .nav-item { display: flex; align-items: center; gap: 12px; padding: 12px 15px; color: var(--text-dim); text-decoration: none; border-radius: 10px; margin-bottom: 8px; transition: 0.3s; }
        .nav-item.active { background: var(--primary); color: white; }

        /* Main Content */
        .content { flex: 1; padding: 40px; display: flex; flex-direction: column; gap: 20px; }
        .invoice-card { background: var(--card-bg); border-radius: 20px; border: 1px solid var(--border); padding: 40px; }
        
        /* Form Inputs */
        input, select, textarea { background: #0f172a; border: 1px solid var(--border); padding: 10px; border-radius: 8px; color: white; width: 100%; box-sizing: border-box; }
        .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 30px; }
        
        /* Table */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th { text-align: left; padding: 12px; color: var(--text-dim); font-size: 13px; }
        td { padding: 10px; border-bottom: 1px solid var(--border); }
        
        /* Buttons */
        .btn { padding: 12px 25px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; display: inline-flex; align-items: center; gap: 8px; }
        .btn-add { background: rgba(59, 130, 246, 0.1); color: var(--primary); }
        .btn-save { background: var(--primary); color: white; }
        .btn-clear { background: #ef4444; color: white; }
        .btn-print { background: #10b981; color: white; }

        .total-section { margin-top: 30px; text-align: right; }
    </style>
</head>
<body>

<div class="sidebar">
    <h2 style="color: var(--primary);">Bill Nova</h2>
    <a href="dashboard.html" class="nav-item"><i class="fas fa-home"></i> Dashboard</a>
    <a href="invoice-history.html" class="nav-item"><i class="fas fa-file-invoice"></i> Invoices</a>
    <a href="clients.html" class="nav-item"><i class="fas fa-users"></i> Clients</a>
    <a href="profile.html" class="nav-item"><i class="fas fa-user-cog"></i> Settings</a>
</div>

<div class="content">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h1>New Invoice</h1>
        <div style="display:flex; gap:10px;">
            <button class="btn btn-clear" onclick="clearInvoice()">Clear</button>
            <button class="btn btn-print" onclick="generatePDF()">Print PDF</button>
            <button class="btn btn-save" onclick="saveInvoice()" id="saveBtn">Save & Sync</button>
        </div>
    </div>

    <div class="invoice-card" id="invoice-render">
        <div class="grid">
            <div>
                <h3 style="color:var(--primary)">From:</h3>
                <p id="myBizName" style="font-size:1.2rem; font-weight:bold; margin:0;"></p>
                <p id="myBizAddr" style="color:var(--text-dim); margin:5px 0;"></p>
                <p id="myBizGst" style="color:var(--text-dim); font-size:12px;"></p>
            </div>
            <div style="text-align: right;">
                <h1 style="margin:0">INVOICE</h1>
                <p># <input id="invNumber" style="width:100px; display:inline;" placeholder="0001"></p>
                <p>Date: <input type="date" id="invDate" style="width:150px; display:inline;"></p>
            </div>
        </div>

        <div class="grid">
            <div>
                <h3 style="color:var(--primary)">Bill To:</h3>
                <input id="clientName" placeholder="Client Name (e.g., Somesh Chandra Pandey)">
                <input id="clientGst" placeholder="Client GSTIN (Optional)" style="margin-top:10px;">
            </div>
        </div>

        <table>
            <thead>
                <tr>
                    <th width="50%">Description</th>
                    <th>Qty</th>
                    <th>Price</th>
                    <th>Total</th>
                    <th></th>
                </tr>
            </thead>
            <tbody id="itemRows">
                <tr>
                    <td><input class="item-desc" placeholder="Product/Service"></td>
                    <td><input type="number" class="item-qty" value="1" oninput="calcRow(this)"></td>
                    <td><input type="number" class="item-price" value="0" oninput="calcRow(this)"></td>
                    <td class="item-total">₹0.00</td>
                    <td><button class="btn" style="color:#ef4444;" onclick="removeRow(this)"><i class="fas fa-times"></i></button></td>
                </tr>
            </tbody>
        </table>
        
        <button class="btn btn-add" style="margin-top:20px;" onclick="addRow()">+ Add Item</button>

        <div class="total-section">
            <p>Subtotal: <span id="subtotal">₹0.00</span></p>
            <p>GST (18%): <span id="gstAmount">₹0.00</span></p>
            <h2 style="color:var(--primary)">Grand Total: <span id="grandTotal">₹0.00</span></h2>
        </div>
    </div>
</div>

<script>
const firebaseConfig = { apiKey: "AIzaSyBNQbvniq3dP6yfX-PGTu3dNuf-6jto3bU", authDomain: "bill-nova.firebaseapp.com", projectId: "bill-nova" };
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

let userProfile = {};

auth.onAuthStateChanged(user => {
    if (user) { loadProfile(user.uid); } 
    else { location.href = "index.html"; }
});

async function loadProfile(uid) {
    const snap = await db.collection("users").doc(uid).get();
    if(snap.exists) {
        userProfile = snap.data().profile || {};
        document.getElementById('myBizName').innerText = userProfile.companyName || "My Business";
        document.getElementById('myBizAddr').innerText = userProfile.address || "Address not set";
        document.getElementById('myBizGst').innerText = "GSTIN: " + (userProfile.gstin || "N/A");
    }
}

function addRow() {
    const row = `<tr>
        <td><input class="item-desc" placeholder="Product/Service"></td>
        <td><input type="number" class="item-qty" value="1" oninput="calcRow(this)"></td>
        <td><input type="number" class="item-price" value="0" oninput="calcRow(this)"></td>
        <td class="item-total">₹0.00</td>
        <td><button class="btn" style="color:#ef4444;" onclick="removeRow(this)"><i class="fas fa-times"></i></button></td>
    </tr>`;
    document.getElementById('itemRows').insertAdjacentHTML('beforeend', row);
}

function removeRow(btn) { btn.closest('tr').remove(); updateTotals(); }

function calcRow(input) {
    const row = input.closest('tr');
    const qty = row.querySelector('.item-qty').value || 0;
    const price = row.querySelector('.item-price').value || 0;
    row.querySelector('.item-total').innerText = '₹' + (qty * price).toFixed(2);
    updateTotals();
}

function updateTotals() {
    let sub = 0;
    document.querySelectorAll('.item-total').forEach(el => {
        sub += parseFloat(el.innerText.replace('₹', '')) || 0;
    });
    const gst = sub * 0.18;
    document.getElementById('subtotal').innerText = '₹' + sub.toFixed(2);
    document.getElementById('gstAmount').innerText = '₹' + gst.toFixed(2);
    document.getElementById('grandTotal').innerText = '₹' + (sub + gst).toFixed(2);
}

async function saveInvoice() {
    const btn = document.getElementById('saveBtn');
    btn.innerText = "Syncing...";
    btn.disabled = true;

    const items = [];
    document.querySelectorAll('#itemRows tr').forEach(row => {
        items.push({
            desc: row.querySelector('.item-desc').value,
            qty: row.querySelector('.item-qty').value,
            price: row.querySelector('.item-price').value
        });
    });

    const invoiceData = {
        invoiceNumber: document.getElementById('invNumber').value,
        date: document.getElementById('invDate').value,
        clientName: document.getElementById('clientName').value,
        clientGst: document.getElementById('clientGst').value,
        items: items,
        totalAmount: document.getElementById('grandTotal').innerText.replace('₹', ''),
        status: "Pending",
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    try {
        // Saving to the protected user sub-collection
        await db.collection("users").doc(auth.currentUser.uid).collection("invoices").add(invoiceData);
        alert("Invoice Saved Successfully!");
        location.href = "invoice-history.html";
    } catch (e) {
        alert("Save Error: " + e.message); //
        btn.disabled = false;
        btn.innerText = "Save & Sync";
    }
}

function generatePDF() {
    const element = document.getElementById('invoice-render');
    const opt = { margin: 1, filename: 'Invoice.pdf', image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' } };
    html2pdf().set(opt).from(element).save();
}

function clearInvoice() {
    if(confirm("Clear all data?")) location.reload();
}
</script>
</body>
</html>
