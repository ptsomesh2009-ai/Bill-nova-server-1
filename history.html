<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Invoice History | Bill Nova</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    <style>
        :root { --primary: #3b82f6; --bg-dark: #0f172a; --card-bg: #1e293b; --text-main: #f8fafc; --text-dim: #94a3b8; --border: rgba(255, 255, 255, 0.1); }
        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg-dark); color: var(--text-main); display: flex; min-height: 100vh; }
        
        /* Sidebar */
        .sidebar { width: 260px; background: rgba(15, 23, 42, 0.9); border-right: 1px solid var(--border); padding: 30px 20px; }
        .nav-item { display: flex; align-items: center; gap: 12px; padding: 12px 15px; color: var(--text-dim); text-decoration: none; border-radius: 10px; margin-bottom: 8px; transition: 0.3s; }
        .nav-item.active { background: var(--primary); color: white; }
        .nav-item:hover:not(.active) { background: rgba(255,255,255,0.05); color: white; }

        /* Main Content */
        .content { flex: 1; padding: 40px; overflow-y: auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        
        /* Table Styles */
        .table-container { background: var(--card-bg); border-radius: 15px; border: 1px solid var(--border); overflow: hidden; }
        table { width: 100%; border-collapse: collapse; text-align: left; }
        th { background: rgba(0,0,0,0.2); padding: 15px; color: var(--text-dim); font-size: 13px; text-transform: uppercase; }
        td { padding: 15px; border-top: 1px solid var(--border); font-size: 14px; }
        tr:hover { background: rgba(255,255,255,0.02); }

        .status-pill { padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; }
        .paid { background: rgba(16, 185, 129, 0.2); color: #10b981; }
        .pending { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }
        
        .action-btn { background: none; border: none; color: var(--text-dim); cursor: pointer; padding: 5px; transition: 0.2s; }
        .action-btn:hover { color: var(--primary); }
        
        #loading { text-align: center; padding: 50px; color: var(--text-dim); }
    </style>
</head>
<body>

<div class="sidebar">
    <h2 style="color: var(--primary); margin-bottom: 40px;">Bill Nova</h2>
    <a href="dashboard.html" class="nav-item"><i class="fas fa-home"></i> Dashboard</a>
    <a href="invoice-history.html" class="nav-item active"><i class="fas fa-file-invoice"></i> Invoices</a>
    <a href="clients.html" class="nav-item"><i class="fas fa-users"></i> Clients</a>
    <a href="profile.html" class="nav-item"><i class="fas fa-user-cog"></i> Settings</a>
</div>

<div class="content">
    <div class="header">
        <h1>Invoice History</h1>
        <button onclick="location.href='create-invoice.html'" style="background:var(--primary); color:white; border:none; padding:10px 20px; border-radius:8px; cursor:pointer; font-weight:bold;">
            + Create New Invoice
        </button>
    </div>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Invoice ID</th>
                    <th>Client Name</th>
                    <th>Date</th>
                    <th>Amount</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="invoiceList">
                </tbody>
        </table>
        <div id="loading">Searching for invoices...</div>
    </div>
</div>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyBNQbvniq3dP6yfX-PGTu3dNuf-6jto3bU",
    authDomain: "bill-nova.firebaseapp.com",
    projectId: "bill-nova"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

auth.onAuthStateChanged(user => {
    if (user) {
        loadInvoices(user.uid);
    } else {
        location.href = "index.html";
    }
});

async function loadInvoices(uid) {
    const listBody = document.getElementById('invoiceList');
    const loading = document.getElementById('loading');

    try {
        // Fetching from the user-specific sub-collection
        const snapshot = await db.collection("users").doc(uid).collection("invoices")
                                 .orderBy("createdAt", "desc").get();

        loading.style.display = 'none';
        listBody.innerHTML = '';

        if (snapshot.empty) {
            listBody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding:30px; color:gray;">No invoices found. Create your first one!</td></tr>`;
            return;
        }

        snapshot.forEach(doc => {
            const data = doc.data();
            const date = data.createdAt ? new Date(data.createdAt.seconds * 1000).toLocaleDateString() : 'N/A';
            
            const row = `
                <tr>
                    <td style="font-weight:bold;">#${data.invoiceNumber || doc.id.substring(0,6)}</td>
                    <td>${data.clientName || 'Unknown Client'}</td>
                    <td>${date}</td>
                    <td>â‚¹${data.totalAmount || '0.00'}</td>
                    <td><span class="status-pill ${data.status === 'Paid' ? 'paid' : 'pending'}">${data.status || 'Pending'}</span></td>
                    <td>
                        <button class="action-btn" title="View PDF" onclick="viewInvoice('${doc.id}')"><i class="fas fa-eye"></i></button>
                        <button class="action-btn" title="Delete" onclick="deleteInvoice('${doc.id}')" style="color:#ef4444;"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `;
            listBody.innerHTML += row;
        });
    } catch (err) {
        console.error(err);
        loading.innerText = "Error loading invoices: " + err.message; //
    }
}

function viewInvoice(id) {
    // Pass the ID to a viewer or print page
    sessionStorage.setItem("viewInvoiceId", id);
    location.href = "view-invoice.html";
}

async function deleteInvoice(id) {
    if(confirm("Are you sure you want to delete this invoice?")) {
        const uid = auth.currentUser.uid;
        await db.collection("users").doc(uid).collection("invoices").doc(id).delete();
        loadInvoices(uid); // Refresh list
    }
}
</script>
</body>
</html>
