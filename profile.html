<!DOCTYPE html>

<html lang="en">

<head>

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Account Settings | BillNova</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    

    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>

    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>

    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>



    <style>

        :root {

            --primary: #3b82f6;

            --primary-dark: #2563eb;

            --bg-dark: #0f172a;

            --card-bg: #1e293b;

            --text-main: #f8fafc;

            --text-dim: #94a3b8;

            --border: rgba(255, 255, 255, 0.1);

            --success: #10b981;

        }



        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg-dark); color: var(--text-main); }

        .page-layout { display: flex; min-height: 100vh; }



        .sidebar {

            width: 260px;

            background: rgba(15, 23, 42, 0.95);

            border-right: 1px solid var(--border);

            padding: 30px 20px;

        }



        .nav-item {

            display: flex; align-items: center; gap: 12px; padding: 12px 15px;

            color: var(--text-dim); text-decoration: none; border-radius: 10px;

            margin-bottom: 8px; transition: 0.3s;

        }



        .nav-item.active { background: var(--primary); color: white; }

        .nav-item:hover:not(.active) { background: rgba(255,255,255,0.05); color: white; }



        .content { flex: 1; padding: 40px; overflow-y: auto; }

        .profile-grid { display: grid; grid-template-columns: 1.5fr 1fr; gap: 30px; }



        .settings-card {

            background: var(--card-bg);

            border-radius: 16px;

            padding: 25px;

            border: 1px solid var(--border);

            margin-bottom: 25px;

        }



        .card-title {

            font-size: 1.1rem; font-weight: 700; margin-bottom: 20px;

            display: flex; align-items: center; gap: 10px; color: var(--primary);

        }



        .form-group { margin-bottom: 18px; }

        label { display: block; font-size: 0.8rem; color: var(--text-dim); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; }

        

        input, textarea {

            width: 100%; background: #0f172a; border: 1px solid var(--border);

            padding: 12px; border-radius: 8px; color: white; font-size: 0.9rem;

            box-sizing: border-box; transition: 0.3s;

        }



        input:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }

        

        .btn-save {

            background: var(--primary); color: white; border: none; padding: 12px 20px;

            border-radius: 8px; font-weight: 600; cursor: pointer; transition: 0.3s; width: 100%;

        }



        .btn-save:hover { background: var(--primary-dark); transform: translateY(-1px); }



        .user-hero { display: flex; align-items: center; gap: 20px; margin-bottom: 30px; }

        .user-avatar {

            width: 80px; height: 80px; border-radius: 20px; 

            background: linear-gradient(135deg, var(--primary), #8b5cf6);

            display: flex; align-items: center; justify-content: center;

            font-size: 2rem; font-weight: 800; color: white;

            overflow: hidden;

        }

        .user-avatar img { width: 100%; height: 100%; object-fit: cover; }



        #toast {

            position: fixed; bottom: 30px; right: 30px; background: var(--success);

            color: white; padding: 12px 25px; border-radius: 8px; display: none; z-index: 1000;

        }

    </style>

</head>

<body>



<div class="page-layout">

    <div class="sidebar">

        <h2 style="margin-bottom: 40px; color: var(--primary); font-size: 1.5rem;">BillNova</h2>

        <nav>

            <a href="dashboard.html" class="nav-item"><i class="fas fa-chart-line"></i> Dashboard</a>

            <a href="invoice.html" class="nav-item"><i class="fas fa-file-invoice"></i> Invoices</a>

            <a href="#" class="nav-item active"><i class="fas fa-user-shield"></i> Settings</a>

            <a href="#" onclick="logout()" class="nav-item" style="margin-top: 100px; color: #f87171;"><i class="fas fa-power-off"></i> Logout</a>

        </nav>

    </div>



    <div class="content">

        <div class="user-hero" id="heroSection">

            <div class="user-avatar" id="avatarBox">B</div>

            <div>

                <h1 id="topBusinessName" style="margin:0; font-size: 1.8rem;">Loading...</h1>

                <p id="userEmail" style="color: var(--text-dim); margin: 5px 0 0 0; font-size: 0.9rem;"></p>

            </div>

        </div>



        <div class="profile-grid">

            <div class="left-col">

                <div class="settings-card">

                    <div class="card-title"><i class="fas fa-store"></i> Business Profile</div>

                    <form id="profileForm">

                        <div class="form-group">

                            <label>Registered Business Name</label>

                            <input type="text" id="bizName" required>

                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">

                            <div class="form-group">

                                <label>GSTIN Number</label>

                                <input type="text" id="bizGst" placeholder="N/A">

                            </div>

                            <div class="form-group">

                                <label>Username</label>

                                <input type="text" id="displayUsername" disabled style="background: rgba(255,255,255,0.05); color: var(--text-dim);">

                            </div>

                        </div>

                        <div class="form-group">

                            <label>Business Address</label>

                            <textarea id="bizAddress" rows="3"></textarea>

                        </div>

                        <button type="submit" class="btn-save" id="saveBtn">Update Profile Details</button>

                    </form>

                </div>

            </div>



            <div class="right-col">

                <div class="settings-card">

                    <div class="card-title"><i class="fas fa-eye"></i> Invoice Header Preview</div>

                    <div id="previewCard" style="background: white; color: #1e293b; padding: 20px; border-radius: 12px;">

                        <div style="border-bottom: 2px solid #f1f5f9; padding-bottom: 10px; margin-bottom: 10px;">

                            <strong id="preName" style="color: #2563eb; font-size: 1rem; display: block;">Business Name</strong>

                            <span id="preGst" style="font-size: 0.75rem; color: #64748b;">GSTIN: -</span>

                        </div>

                        <p id="preAddr" style="font-size: 0.75rem; color: #475569; margin: 0; line-height: 1.4;">Address not set</p>

                    </div>

                </div>

                

                <p style="color: var(--text-dim); font-size: 0.8rem; text-align: center;">

                    Logged in via Google Secure Auth

                </p>

            </div>

        </div>

    </div>

</div>



<div id="toast">Changes saved successfully!</div>



<script>

const firebaseConfig = {

    apiKey: "AIzaSyBNQbvniq3dP6yfX-PGTu3dNuf-6jto3bU",

    authDomain: "bill-nova.firebaseapp.com",

    projectId: "bill-nova"

};

firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();

const db = firebase.firestore();



// Auth State

auth.onAuthStateChanged(user => {

    if (user) {

        document.getElementById('userEmail').innerText = user.email;

        if(user.photoURL) {

            document.getElementById('avatarBox').innerHTML = `<img src="${user.photoURL}">`;

        }

        loadUserData(user.uid);

    } else {

        location.href = "index.html";

    }

});



async function loadUserData(uid) {

    try {

        const snap = await db.collection("users").doc(uid).get();

        if (snap.exists) {

            const data = snap.data();

            const profile = data.profile || {};

            

            document.getElementById('bizName').value = profile.companyName || "";

            document.getElementById('bizGst').value = profile.gstin || "";

            document.getElementById('bizAddress').value = profile.address || "";

            document.getElementById('displayUsername').value = "@" + (data.username || "user");

            

            updatePreview(profile.companyName, profile.gstin, profile.address);

        } else {

            // If user logged in but no data in DB, send to setup

            location.href = "setup.html";

        }

    } catch (e) { console.error("Error loading profile:", e); }

}



function updatePreview(name, gst, addr) {

    document.getElementById('topBusinessName').innerText = name || "New Business";

    document.getElementById('preName').innerText = name || "Business Name";

    document.getElementById('preGst').innerText = "GSTIN: " + (gst || "N/A");

    document.getElementById('preAddr').innerText = addr || "Address not set";

}



// Save Profile

document.getElementById('profileForm').onsubmit = async (e) => {

    e.preventDefault();

    const btn = document.getElementById('saveBtn');

    btn.disabled = true;

    btn.innerText = "Syncing...";



    const profileData = {

        companyName: document.getElementById('bizName').value,

        gstin: document.getElementById('bizGst').value,

        address: document.getElementById('bizAddress').value,

        updatedAt: firebase.firestore.FieldValue.serverTimestamp()

    };



    try {

        // Update only the profile field inside the user document

        await db.collection("users").doc(auth.currentUser.uid).update({

            profile: profileData

        });

        showToast();

    } catch (err) {

        alert("Error saving data: " + err.message);

    }

    btn.disabled = false;

    btn.innerText = "Update Profile Details";

};



function showToast() {

    const t = document.getElementById('toast');

    t.style.display = 'block';

    setTimeout(() => t.style.display = 'none', 3000);

}



function logout() { auth.signOut().then(() => location.href = "index.html"); }



// Live Preview listeners

['bizName', 'bizGst', 'bizAddress'].forEach(id => {

    document.getElementById(id).addEventListener('input', () => {

        updatePreview(

            document.getElementById('bizName').value, 

            document.getElementById('bizGst').value, 

            document.getElementById('bizAddress').value

        );

    });

});

</script>

</body>

</html>
