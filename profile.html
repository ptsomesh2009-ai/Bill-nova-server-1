<style>
    /* Naye styles subscription ke liye */
    .status-active { color: var(--success); font-weight: bold; }
    .status-expired { color: #ef4444; font-weight: bold; }
    .status-inactive { color: var(--text-dim); font-weight: bold; }
    .subscription-info { font-size: 0.85rem; margin-top: 5px; color: var(--text-dim); }
    .btn-activate { background: #f59e0b; color: white; border: none; padding: 10px; border-radius: 8px; cursor: pointer; width: 100%; font-weight: 600; margin-top: 10px; }
    .btn-activate:hover { background: #d97706; }
</style>

<div class="content">
    <div class="profile-grid">
        <div class="left-col">
            <div class="settings-card">
                <div class="card-title"><i class="fas fa-store"></i> Business Profile</div>
                <form id="profileForm">
                    <div class="form-group">
                        <label>Registered Business Name</label>
                        <input type="text" id="bizName" required>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label>GSTIN Number</label>
                            <input type="text" id="bizGst" placeholder="N/A">
                        </div>
                        <div class="form-group">
                            <label>Username</label>
                            <input type="text" id="displayUsername" disabled style="background: rgba(255,255,255,0.05); color: var(--text-dim);">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Business Address</label>
                        <textarea id="bizAddress" rows="3"></textarea>
                    </div>
                    <button type="submit" class="btn-save" id="saveBtn">Update Profile Details</button>
                </form>
            </div>

            <div class="settings-card" style="border-left: 4px solid #f59e0b;">
                <div class="card-title"><i class="fas fa-crown"></i> Software Subscription</div>
                <div id="subStatusBox">
                    <p style="margin: 0;">Status: <span id="currentStatus" class="status-inactive">Checking...</span></p>
                    <p id="expiryInfo" class="subscription-info"></p>
                </div>
                
                <hr style="border: 0; border-top: 1px solid var(--border); margin: 20px 0;">
                
                <div class="form-group">
                    <label>Activate New License Key</label>
                    <input type="text" id="licenseKey" placeholder="Enter Key (e.g. NOVA-XXXX-XXXX)">
                    <button onclick="activateKey()" class="btn-activate" id="activateBtn">Activate Subscription</button>
                </div>
            </div>
        </div>

        <div class="right-col">
            <div class="settings-card">
                <div class="card-title"><i class="fas fa-eye"></i> Invoice Header Preview</div>
                <div id="previewCard" style="background: white; color: #1e293b; padding: 20px; border-radius: 12px;">
                    <div style="border-bottom: 2px solid #f1f5f9; padding-bottom: 10px; margin-bottom: 10px;">
                        <strong id="preName" style="color: #2563eb; font-size: 1rem; display: block;">Business Name</strong>
                        <span id="preGst" style="font-size: 0.75rem; color: #64748b;">GSTIN: -</span>
                    </div>
                    <p id="preAddr" style="font-size: 0.75rem; color: #475569; margin: 0; line-height: 1.4;">Address not set</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// ... (Firebase Initialize same as before) ...

async function loadUserData(uid) {
    try {
        const snap = await db.collection("users").doc(uid).get();
        if (snap.exists) {
            const data = snap.data();
            const profile = data.profile || {};
            
            document.getElementById('bizName').value = profile.companyName || "";
            document.getElementById('bizGst').value = profile.gstin || "";
            document.getElementById('bizAddress').value = profile.address || "";
            document.getElementById('displayUsername').value = "@" + (data.username || "user");
            
            // Check Subscription Status
            const expiry = data.subscriptionExpiry; // Firestore timestamp or null
            const statusEl = document.getElementById('currentStatus');
            const infoEl = document.getElementById('expiryInfo');

            if (!expiry) {
                statusEl.innerText = "No Active Plan";
                statusEl.className = "status-inactive";
                infoEl.innerText = "Enter a key to start using BillNova.";
            } else {
                const expiryDate = expiry.toDate();
                const now = new Date();
                
                if (expiryDate > now) {
                    statusEl.innerText = "Active";
                    statusEl.className = "status-active";
                    infoEl.innerText = "Valid until: " + expiryDate.toLocaleDateString();
                } else {
                    statusEl.innerText = "Expired";
                    statusEl.className = "status-expired";
                    infoEl.innerText = "Expired on: " + expiryDate.toLocaleDateString();
                }
            }
            
            updatePreview(profile.companyName, profile.gstin, profile.address);
        }
    } catch (e) { console.error(e); }
}

async function activateKey() {
    const keyInput = document.getElementById('licenseKey').value.trim();
    if (!keyInput) return alert("Please enter a key!");

    const btn = document.getElementById('activateBtn');
    btn.disabled = true;
    btn.innerText = "Verifying...";

    try {
        const keyRef = db.collection("subscriptionKeys").doc(keyInput);
        
        // Use Transaction to prevent double usage
        await db.runTransaction(async (transaction) => {
            const keyDoc = await transaction.get(keyRef);

            if (!keyDoc.exists) {
                throw "Invalid Key! Please check again.";
            }

            const keyData = keyDoc.data();
            if (keyData.isUsed) {
                throw "This key has already been used!";
            }

            // Calculate new expiry date
            const daysToAdd = keyData.days || 30;
            let currentExpiry = new Date();
            
            // If user already has an active sub, extend it. Otherwise, start from today.
            const userSnap = await transaction.get(db.collection("users").doc(auth.currentUser.uid));
            const existingExpiry = userSnap.data().subscriptionExpiry;
            if (existingExpiry && existingExpiry.toDate() > new Date()) {
                currentExpiry = existingExpiry.toDate();
            }

            currentExpiry.setDate(currentExpiry.getDate() + daysToAdd);

            // Update user document
            transaction.update(db.collection("users").doc(auth.currentUser.uid), {
                subscriptionExpiry: firebase.firestore.Timestamp.fromDate(currentExpiry)
            });

            // Mark key as used
            transaction.update(keyRef, {
                isUsed: true,
                usedBy: auth.currentUser.uid,
                activatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        });

        alert("Subscription Activated Successfully!");
        location.reload(); // Refresh to show new status

    } catch (err) {
        alert(err);
        btn.disabled = false;
        btn.innerText = "Activate Subscription";
    }
}
// ... (rest of the profile functions) ...
</script>
