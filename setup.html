<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Bill Nova | Account Setup</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    <style>
        body{margin:0;background:#0f172a;color:white;font-family:Arial;display:flex;justify-content:center;align-items:center;min-height:100vh}
        .box{width:400px;padding:30px;background:#020617;border-radius:12px;border:1px solid #1e293b}
        input, textarea, button{width:100%;padding:12px;margin:8px 0;border-radius:6px;border:1px solid #334155;background:#0f172a;color:white;box-sizing:border-box}
        button{background:#3b82f6;border:none;font-weight:bold;cursor:pointer;margin-top:20px}
        .section-title{color:#94a3b8;font-size:12px;text-transform:uppercase;margin-top:15px;display:block}
    </style>
</head>
<body>

<div class="box">
    <h2 style="text-align:center">Finalize Your Account</h2>
    
    <span class="section-title">Login Credentials (Compulsory)</span>
    <input id="username" placeholder="Choose Username">
    <input id="key" placeholder="Daily Login Key" type="password">

    <span class="section-title">Business Details (Optional - Can change later)</span>
    <input id="bizName" placeholder="Business / Shop Name">
    <input id="bizGst" placeholder="GSTIN (Optional)">
    <textarea id="bizAddress" placeholder="Full Address"></textarea>

    <button onclick="completeSetup()" id="setupBtn">Create My Business Profile</button>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBNQbvniq3dP6yfX-PGTu3dNuf-6jto3bU",
        authDomain: "bill-nova.firebaseapp.com",
        projectId: "bill-nova"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    async function completeSetup() {
        const user = auth.currentUser;
        if(!user) return alert("Please sign in with Google first!");

        const u = document.getElementById("username").value.trim().toLowerCase();
        const k = document.getElementById("key").value.trim();
        const bName = document.getElementById("bizName").value.trim() || "My Business";
        const bGst = document.getElementById("bizGst").value.trim();
        const bAddr = document.getElementById("bizAddress").value.trim();

        if(!u || !k) return alert("Username and Login Key are required!");

        const btn = document.getElementById("setupBtn");
        btn.innerText = "Initializing Database...";
        btn.disabled = true;

        try {
            // Write to users/{userId} to satisfy Security Rules
            await db.collection("users").doc(user.uid).set({
                username: u,
                dailyLoginKeyHash: k,
                role: "user",
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                profile: {
                    companyName: bName,
                    gstin: bGst,
                    address: bAddr,
                    email: user.email
                }
            });

            alert("Setup Complete!");
            location.href = "dashboard.html";
        } catch (e) {
            alert("Permission Error: " + e.message); //
            btn.disabled = false;
            btn.innerText = "Create My Business Profile";
        }
    }
</script>
</body>
</html>
