<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Bill Nova | Account Setup</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    <style>
        body{margin:0;background:#0f172a;color:white;font-family:'Inter', sans-serif;display:flex;justify-content:center;align-items:center;min-height:100vh}
        .box{width:400px;padding:30px;background:#1e293b;border-radius:12px;border:1px solid #334155;box-shadow: 0 10px 25px rgba(0,0,0,0.3);}
        input, textarea, button{width:100%;padding:12px;margin:8px 0;border-radius:6px;border:1px solid #334155;background:#0f172a;color:white;box-sizing:border-box;outline:none;}
        input:focus, textarea:focus { border-color: #3b82f6; }
        button{background:#3b82f6;border:none;font-weight:bold;cursor:pointer;margin-top:20px; transition: 0.3s;}
        button:hover{background:#2563eb;}
        button:disabled{background:#334155; cursor:not-allowed;}
        .section-title{color:#94a3b8;font-size:11px;text-transform:uppercase;margin-top:15px;display:block;font-weight:bold;letter-spacing:1px;}
    </style>
</head>
<body>

<div class="box">
    <h2 style="text-align:center; margin-bottom: 20px;">Finalize Your Account</h2>
    
    <span class="section-title">Step 1: Create Fast Login Access</span>
    <input id="username" placeholder="Choose Unique Username (No spaces)">
    <input id="key" placeholder="Daily Login Key (min 6 chars)" type="password">

    <span class="section-title">Step 2: Business Details (Optional)</span>
    <input id="bizName" placeholder="Business / Shop Name">
    <input id="bizGst" placeholder="GSTIN (Optional)">
    <textarea id="bizAddress" placeholder="Full Address" rows="3"></textarea>

    <button onclick="completeSetup()" id="setupBtn">Complete Setup & Dashboard</button>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBNQbvniq3dP6yfX-PGTu3dNuf-6jto3bU",
        authDomain: "bill-nova.firebaseapp.com",
        projectId: "bill-nova"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    async function completeSetup() {
        const currentUser = auth.currentUser;
        if(!currentUser) return alert("Session expired. Please login with Google again.");

        const u = document.getElementById("username").value.trim().toLowerCase().replace(/\s+/g, '');
        const k = document.getElementById("key").value.trim();
        const bName = document.getElementById("bizName").value.trim() || "My Business";
        const bGst = document.getElementById("bizGst").value.trim() || "N/A";
        const bAddr = document.getElementById("bizAddress").value.trim() || "";

        if(!u || k.length < 6) return alert("Username is required and Key must be at least 6 characters!");

        const btn = document.getElementById("setupBtn");
        btn.innerText = "Processing Fast Login...";
        btn.disabled = true;

        try {
            // 1. Check if username is already taken in Firestore
            const usernameCheck = await db.collection("users").where("username", "==", u).get();
            if(!usernameCheck.empty) {
                alert("This username is already taken. Please choose another one.");
                btn.disabled = false;
                btn.innerText = "Complete Setup & Dashboard";
                return;
            }

            // 2. Create the Fast Login account in Firebase Auth (the 'fake' email)
            const fakeEmail = u + "@billnova.com";
            
            // Note: We create this while being logged in with Google. 
            // Firebase allows this, but we'll store the connection in Firestore.
            let secondaryUid = "";
            try {
                const credential = await auth.createUserWithEmailAndPassword(fakeEmail, k);
                secondaryUid = credential.user.uid;
            } catch (authErr) {
                if(authErr.code === 'auth/email-already-in-use') {
                    alert("This username is already registered in our auth system.");
                } else {
                    alert("Auth Error: " + authErr.message);
                }
                btn.disabled = false;
                btn.innerText = "Complete Setup & Dashboard";
                return;
            }

            // 3. Save everything to Firestore under the GOOGLE UID 
            // We use the Google UID as the primary account reference
            await db.collection("users").doc(currentUser.uid).set({
                username: u,
                fastLoginUid: secondaryUid, // Link to the fast login account
                role: "user",
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                profile: {
                    companyName: bName,
                    gstin: bGst,
                    address: bAddr,
                    email: currentUser.email
                }
            });

            // 4. Also create a small reference for the Fast Login UID 
            // so the system knows which Google account it belongs to
            await db.collection("fastLoginMap").doc(secondaryUid).set({
                primaryUid: currentUser.uid
            });

            alert("Account Linked Successfully! You can now use Fast Login.");
            location.href = "dashboard.html";

        } catch (e) {
            console.error(e);
            alert("Setup Error: " + e.message);
            btn.disabled = false;
            btn.innerText = "Complete Setup & Dashboard";
        }
    }
</script>
</body>
</html>
