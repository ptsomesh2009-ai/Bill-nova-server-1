<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Bill Nova | Account Setup</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    <style>
        body{margin:0;background:#0f172a;color:white;font-family:'Inter', sans-serif;display:flex;justify-content:center;align-items:center;min-height:100vh}
        .box{width:400px;padding:30px;background:#1e293b;border-radius:12px;border:1px solid #334155;box-shadow: 0 10px 25px rgba(0,0,0,0.3);}
        input, textarea, button{width:100%;padding:12px;margin:8px 0;border-radius:6px;border:1px solid #334155;background:#0f172a;color:white;box-sizing:border-box;outline:none;}
        input:focus, textarea:focus { border-color: #3b82f6; }
        button{background:#3b82f6;border:none;font-weight:bold;cursor:pointer;margin-top:20px; transition: 0.3s;}
        button:hover{background:#2563eb;}
        button:disabled{background:#334155; cursor:not-allowed;}
        .section-title{color:#94a3b8;font-size:11px;text-transform:uppercase;margin-top:15px;display:block;font-weight:bold;letter-spacing:1px;}
        .notice-text { font-size: 12px; color: #94a3b8; text-align: center; margin-bottom: 20px; line-height: 1.4; }
    </style>
</head>
<body>

<div class="box">
    <h2 style="text-align:center; margin-bottom: 10px;">Account Setup</h2>
    <p class="notice-text">Please finalize your business profile to start generating professional invoices.</p>
    
    <span class="section-title">Identity</span>
    <input id="username" placeholder="Choose a Unique Username">

    <span class="section-title">Business Details (Optional)</span>
    <input id="bizName" placeholder="Business / Shop Name">
    <input id="bizGst" placeholder="GSTIN (e.g. 22AAAAA0000A1Z5)">
    <textarea id="bizAddress" placeholder="Full Business Address" rows="3"></textarea>

    <button onclick="completeSetup()" id="setupBtn">Finalize & Enter Dashboard</button>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBNQbvniq3dP6yfX-PGTu3dNuf-6jto3bU",
        authDomain: "bill-nova.firebaseapp.com",
        projectId: "bill-nova"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    async function completeSetup() {
        const currentUser = auth.currentUser;
        if(!currentUser) {
            alert("No active session. Redirecting to login...");
            location.href = "index.html";
            return;
        }

        const u = document.getElementById("username").value.trim().toLowerCase().replace(/\s+/g, '');
        const bName = document.getElementById("bizName").value.trim() || "My Business";
        const bGst = document.getElementById("bizGst").value.trim() || "N/A";
        const bAddr = document.getElementById("bizAddress").value.trim() || "";

        if(!u) return alert("Please choose a unique username!");
        if(u.length < 3) return alert("Username must be at least 3 characters.");

        const btn = document.getElementById("setupBtn");
        btn.innerText = "Saving Profile...";
        btn.disabled = true;

        try {
            // 1. Double check username uniqueness in Firestore
            const usernameCheck = await db.collection("users").where("username", "==", u).get();
            if(!usernameCheck.empty) {
                alert("This username is already taken. Please choose another one.");
                btn.disabled = false;
                btn.innerText = "Finalize & Enter Dashboard";
                return;
            }

            // 2. Save Business Profile directly under the Google UID
            await db.collection("users").doc(currentUser.uid).update({
                username: u,
                role: "user",
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                profile: {
                    companyName: bName,
                    gstin: bGst,
                    address: bAddr,
                    email: currentUser.email,
                    photoURL: currentUser.photoURL || ""
                }
            });

            // Success Redirect
            location.href = "dashboard.html";

        } catch (e) {
            console.error(e);
            alert("Setup Error: " + e.message);
            btn.disabled = false;
            btn.innerText = "Finalize & Enter Dashboard";
        }
    }
</script>
</body>
</html>

